{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load static %}
{% load content_tags %}

<link rel="stylesheet" href="{% static 'custom.css' %}">
<script src="https://unpkg.com/htmx.org@2.0.4"></script>

<style>
    .main-container {
        margin: 5rem auto 5rem auto;
        border: 2px solid #fbf408;
    }

</style>

{% block content %}

<div class="main-container">
    <h1 class="post-title">{{ sub_posts.0.main_post.title }}</h1>

    {% for sub_post in sub_posts %}
        <div class="post-card" data-post-id="{{ sub_post.id }}">
            <div class="post-number">post {{ forloop.counter }}</div>
            <div class="post-text">{{ sub_post.title|linebreaksbr }}</div>

            {% if sub_post.postcontent_set.exists %}
                {% for content in sub_post.postcontent_set.all %}
                    {% if content.content.content_type.model == 'text' %}
                        <p>{{ content.content.item.text|linebreaksbr }}</p>
                    {% elif content.content.content_type.model == 'file' %}
                        <a href="{{ content.content.item.file.url }}" class="file-download">
                            <i class="fas fa-download me-2"></i>Download File
                        </a>
                    {% elif content.content.content_type.model == 'image' %}
                        <div class="image-container">
                            <img src="{{ content.content.item.image.url }}" alt="post Image" class="content-image">
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if sub_post.post_type.post_type == '객관식' %}
                <form hx-post="{% url 'basiccontent:submit_user_answer' pk=sub_post.id %}"
                      hx-trigger="change"
                      hx-swap="none"
                      hx-ext="debug">
                    {% csrf_token %}
                    {% for choice in sub_post.useranswer_set.all %}
                        <div class="choice-container">
                            <input type="radio"
                                   id="choice_{{ choice.id }}"
                                   name="answer"
                                   value="{{ choice.id }}"
                                   class="choice-input"
                                   {% if sub_post.answer.id == choice.id %}checked{% endif %}>
                            <label for="choice_{{ choice.id }}" class="choice-label">
                                {{ choice.answer_description }}
                            </label>
                        </div>
                    {% endfor %}
                </form>
            {% elif sub_post.post_type.post_type == '주관식(다중서술형)' %}
                <div id="multi-subjective-container-{{ sub_post.id }}">
                    {% for multisubjective in sub_post.multisubjectiveanswers_set.all %}
                        <form hx-post="{% url 'basiccontent:multi-subjective-answers' pk=multisubjective.id %}"
                              hx-target="#multi-subjective-container-{{ post.id }}"
                              hx-swap="innerHTML"
                              class="multi-answer-form">
                        {% csrf_token %}
                        <div id="save-status-{{ multisubjective.id }}"></div> <!-- 저장 상태 표시 영역 -->
                        <div class="mb-3">
                            <label for="answer_{{ post.id }}_{{ multisubjective.answer_number }}" class="form-label">
                                답안 ({{ multisubjective.answer_number }}) <span>*답안 번호에 맞게 입력해야 정답으로 인정됩니다.</span>
                            </label>
                            <div class="position-relative">
                                <textarea
                                    class="form-control"
                                    name="answer_description"
                                    id="answer_{{ post.id }}_{{ multisubjective.answer_number }}"
                                    placeholder="이곳에 답변 ({{ multisubjective.answer_number }})을 입력하세요. 답안 번호에 맞게 입력해야 정답으로 인정됩니다."
                                    rows="3"
                                    hx-swap="innerHTML"
                                >{{ multisubjective.answer_description|default:'' }}</textarea>
                                <input type="hidden" name="answer_number" value="{{ multisubjective.answer_number }}">
                            </div>
                        </div>

                        <button type="submit"
                                class="btn btn-sm btn-secondary"
                                hx-target="#save-status-{{ multisubjective.id }}"
                                hx-swap="innerHTML">임시 저장</button>
                        </form>
                    {% endfor %}
                </div>

            {% else %}
                <form hx-post="{% url 'basiccontent:examiner-test-submit-answer' pk=post.id %}"
                      hx-target="#feedback-{{ post.id }}"
                      hx-swap="innerHTML"
                      hx-ext="debug">
                    {% csrf_token %}
                    <div class="position-relative">
                        <textarea
                            class="answer-textarea"
                            name="user_subjective_answer"
                            id="answer_{{ post.id }}"
                            placeholder="이곳에 답변을 입력하세요..."
                            hx-swap="innerHTML"
                        >{{ post.user_subjective_answer|default:'' }}</textarea>
                    </div>

                    <div class="answer-feedback" id="feedback-{{ post.id }}"></div>
                    <button type="submit" class="btn btn-sm btn-secondary">임시저장</button>
                </form>
            {% endif %}
        </div>
    {% endfor %}

    <button type="submit" class="btn btn-primary" onclick="validateAndSubmit()" style="margin-bottom: 5rem;">제출하기</button>
    <br/>
</div>
{% endblock %}


<script>
function validateAndSubmit() {
    const posts = document.querySelectorAll('.post-card');
    let allAnswered = true;
    let emptyposts = [];

    posts.forEach((post, index) => {
        const postId = post.getAttribute('data-post-id');
        const isMultiSubjective = post.querySelector('#multi-subjective-container-' + postId);
        const textarea = post.querySelector('textarea');
        const radioInputs = post.querySelectorAll('input[type="radio"]');
        {#const form = post.querySelector('form');#}

        if (isMultiSubjective) {
            // This is a multi-subjective post
            const multiAnswerForms = post.querySelectorAll('.multi-answer-form');
            let allMultiAnswered = true;

            multiAnswerForms.forEach(form => {
                const multiTextarea = form.querySelector('textarea');
                if (!multiTextarea.value.trim()) {
                    allMultiAnswered = false;
                } else {
                    // Trigger HTMX temporary save for each multi-answer
                    multiTextarea.value = multiTextarea.value.trim();
                    htmx.trigger(form, 'submit');
                }
            });

            if (!allMultiAnswered) {
                allAnswered = false;
                emptyposts.push(index + 1);

                post.scrollIntoView({behavior: 'smooth', block: 'center'});
                post.style.border = '2px solid red';
                setTimeout(() => {
                    post.style.border = '';
                }, 2000);

            }
        } else if (textarea) {
            // This is a subjective post
            if (!textarea.value.trim()) {
                allAnswered = false;
                emptyposts.push(index + 1);

                post.scrollIntoView({behavior: 'smooth', block: 'center'});
                post.style.border = '2px solid red';
                setTimeout(() => {
                    post.style.border = '';
                }, 2000);

            } else {
                // Trigger HTMX temporary save for each post
                const form = post.querySelector('form');
                textarea.value = textarea.value.trim();
                htmx.trigger(form, 'submit');
            }
        } else if (radioInputs.length > 0) {
            // This is an objective post
            const answered = Array.from(radioInputs).some(input => input.checked);
            if (!answered) {
                allAnswered = false;
                emptyposts.push(index + 1);

                post.scrollIntoView({behavior: 'smooth', block: 'center'});
                post.style.border = '2px solid red';
                setTimeout(() => {
                    post.style.border = '';
                }, 2000);

            }
        }
    });

    if (!allAnswered) {
        showInfo(`다음 문항에 답변을 입력해 주세요: ${emptyposts.join(', ')}`);
        return;
    }

    const hasSubjective = Array.from(posts).some(q => q.querySelector('textarea'));

    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    // Add additional data
    const domainGradeNameInput = document.createElement('input');
    domainGradeNameInput.type = 'hidden';
    domainGradeNameInput.name = 'domain_grade_detail_id';
    domainGradeNameInput.value = "{{ posts.0.apply_info.exam_phase_place.exam_phase.exam.domain_grade_detail.id }}";
    form.appendChild(domainGradeNameInput);

    // Submit the form
    document.body.appendChild(form);

    // 폼 데이터 생성
    const formData = new FormData(form);

    // fetch API를 사용하여 비동기 제출
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            if (window.opener) {
                try {
                    window.opener.location.href = "{% url 'basiccontent:exam_end' %}";
                } catch (error) {
                    console.warn("부모 창 이동 실패", error);
                }
            }
            window.close();  // 새 창 닫기
        } else {
            alert('제출에 실패했습니다. 다시 시도해주세요.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('제출 중 오류가 발생했습니다.');
    });
}

</script>