{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load static %}
{% load content_tags %}

<link rel="stylesheet" href="{% static 'custom.css' %}">
<script src="https://unpkg.com/htmx.org@2.0.4"></script>

<style>
    .post-container {
        max-width: 90%;
        margin: 5rem auto;  /* 상단-우측-하단-좌측 */
        padding: 0 1rem;
    }

    .post-title {
        color: #2c3e50;
        margin-bottom: 3rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid #3498db;
    }

    .post-description {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .post-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        margin-left: 2rem;
        margin-right: 2rem;
    }

    .post-number {
        color: #3498db;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .post-text {
        font-size: 1.1rem;
        color: #2c3e50;
        margin-bottom: 1.5rem;
    }

    .content-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s ease;
        transform-origin: left top;
    }

    .image-container:hover {
        z-index: 100; /* 호버된 컨테이너의 z-index를 높여 항상 위에 표시 */
    }

    .image-container:hover .content-image {
        transform: scale(3);
        transform-origin: left top;
        position: relative;
    }

    .image-container {
        width: 200px;
        height: 200px;
        margin: 1rem 0;
        overflow: visible;
        position: relative;
        z-index: 1;
    }

    .file-download {
        display: inline-block;
        padding: 0.5rem 1rem;
        background-color: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        margin: 1rem 0;
        transition: background-color 0.2s;
    }

    .file-download:hover {
        background-color: #2980b9;
        color: white;
    }

    /* 모달 배경을 하얀색으로 변경 */
    .modal-backdrop {
      background-color: white !important;
      opacity: 1 !important;
    }

    /* 입력칸 스타일 수정 */
    .form-control, .form-select {
      background-color: #f8f9fa;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* 입력칸에 포커스 시 스타일 */
    .form-control:focus, .form-select:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      background-color: white;
    }

    /* 모달 콘텐츠 부분 스타일 강화 */
    .modal-content {
      border: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

</style>

{% block content %}

<div class="main-container">
    <h1 class="post-title">{{ sub_posts.0.main_post.title }}</h1>

    {% for sub_post in sub_posts %}
        <div class="post-card" data-post-id="{{ sub_post.id }}">
            <div class="post-number">post {{ forloop.counter }}</div>
            <div class="post-text">{{ sub_post.title|linebreaksbr }}</div>

            {% if sub_post.postcontent_set.exists %}
                {% for content in sub_post.postcontent_set.all %}
                    {% if content.content.content_type.model == 'text' %}
                        <p>{{ content.content.item.text|linebreaksbr }}</p>
                    {% elif content.content.content_type.model == 'file' %}
                        <a href="{{ content.content.item.file.url }}" class="file-download">
                            <i class="fas fa-download me-2"></i>Download File
                        </a>
                    {% elif content.content.content_type.model == 'image' %}
                        <div class="image-container">
                            <img src="{{ content.content.item.image.url }}" alt="post Image" class="content-image">
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if sub_post.post_type.post_type == '객관식' %}
                <form hx-post="{% url 'basiccontent:submit-user-answer' %}"
                      hx-trigger="change"
                      hx-swap="none"
                      hx-ext="debug">
                    {% csrf_token %}
                    {% for choice in sub_post.postoptions_set.all %}
                        <div class="choice-container">
                            <input type="radio"
                                   id="choice_{{ choice.id }}"
                                   name="answer"
                                   value="{{ choice.id }}"
                                   class="choice-input">
                            <label for="choice_{{ choice.id }}" class="choice-label">
                                {{ choice.description }}
                            </label>
                        </div>
                    {% endfor %}
                </form>
            {% elif sub_post.post_type.post_type == '주관식(다중서술형)' %}
                <div id="multi-subjective-container-{{ sub_post.id }}">
                    {% for multisubjective in sub_post.multisubjectiveanswers_set.all %}
                        <form hx-post="{% url 'basiccontent:multi-subjective-answers' pk=multisubjective.id %}"
                              hx-target="#multi-subjective-container-{{ post.id }}"
                              hx-swap="innerHTML"
                              class="multi-answer-form">
                        {% csrf_token %}
                        <div id="save-status-{{ multisubjective.id }}"></div> <!-- 저장 상태 표시 영역 -->
                        <div class="mb-3">
                            <label for="answer_{{ post.id }}_{{ multisubjective.answer_number }}" class="form-label">
                                답안 ({{ multisubjective.answer_number }}) <span>*답안 번호에 맞게 입력해야 정답으로 인정됩니다.</span>
                            </label>
                            <div class="position-relative">
                                <textarea
                                    class="form-control"
                                    name="answer_description"
                                    id="answer_{{ post.id }}_{{ multisubjective.answer_number }}"
                                    placeholder="이곳에 답변 ({{ multisubjective.answer_number }})을 입력하세요. 답안 번호에 맞게 입력해야 정답으로 인정됩니다."
                                    rows="3"
                                    hx-swap="innerHTML"
                                >{{ multisubjective.answer_description|default:'' }}</textarea>
                                <input type="hidden" name="answer_number" value="{{ multisubjective.answer_number }}">
                            </div>
                        </div>

                        <button type="submit"
                                class="btn btn-sm btn-secondary"
                                hx-target="#save-status-{{ multisubjective.id }}"
                                hx-swap="innerHTML">임시 저장</button>
                        </form>
                    {% endfor %}
                </div>

            {% else %}
                <form hx-post="{% url 'basiccontent:submit-user-answer' %}"
                      hx-target="#feedback-{{ post.id }}"
                      hx-swap="innerHTML"
                      hx-ext="debug">
                    {% csrf_token %}
                    <div class="position-relative">
                        <textarea
                            class="form-control"
                            name="subjective_answer"
                            id="answer_{{ post.id }}"
                            placeholder="이곳에 답변을 입력하세요..."
                            hx-swap="innerHTML"
                        >{{ sub_post.subjective_answer|default:'' }}</textarea>
                    </div>

                    <div class="answer-feedback" id="feedback-{{ post.id }}"></div>
                    <button type="submit" class="btn btn-sm btn-secondary">임시저장</button>
                </form>
            {% endif %}
        </div>
    {% endfor %}

    <button type="submit" class="btn btn-primary" onclick="validateAndSubmit()" style="margin-bottom: 5rem;">제출하기</button>
    <br/>
</div>
{% endblock %}


<script>
function validateAndSubmit() {
    const posts = document.querySelectorAll('.post-card');
    let allAnswered = true;
    let emptyposts = [];

    posts.forEach((post, index) => {
        const postId = post.getAttribute('data-post-id');
        const isMultiSubjective = post.querySelector('#multi-subjective-container-' + postId);
        const textarea = post.querySelector('textarea');
        const radioInputs = post.querySelectorAll('input[type="radio"]');
        {#const form = post.querySelector('form');#}

        if (isMultiSubjective) {
            // This is a multi-subjective post
            const multiAnswerForms = post.querySelectorAll('.multi-answer-form');
            let allMultiAnswered = true;

            multiAnswerForms.forEach(form => {
                const multiTextarea = form.querySelector('textarea');
                if (!multiTextarea.value.trim()) {
                    allMultiAnswered = false;
                } else {
                    // Trigger HTMX temporary save for each multi-answer
                    multiTextarea.value = multiTextarea.value.trim();
                    htmx.trigger(form, 'submit');
                }
            });

            if (!allMultiAnswered) {
                allAnswered = false;
                emptyposts.push(index + 1);

                post.scrollIntoView({behavior: 'smooth', block: 'center'});
                post.style.border = '2px solid red';
                setTimeout(() => {
                    post.style.border = '';
                }, 2000);

            }
        } else if (textarea) {
            // This is a subjective post
            if (!textarea.value.trim()) {
                allAnswered = false;
                emptyposts.push(index + 1);

                post.scrollIntoView({behavior: 'smooth', block: 'center'});
                post.style.border = '2px solid red';
                setTimeout(() => {
                    post.style.border = '';
                }, 2000);

            } else {
                // Trigger HTMX temporary save for each post
                const form = post.querySelector('form');
                textarea.value = textarea.value.trim();
                htmx.trigger(form, 'submit');
            }
        } else if (radioInputs.length > 0) {
            // This is an objective post
            const answered = Array.from(radioInputs).some(input => input.checked);
            if (!answered) {
                allAnswered = false;
                emptyposts.push(index + 1);

                post.scrollIntoView({behavior: 'smooth', block: 'center'});
                post.style.border = '2px solid red';
                setTimeout(() => {
                    post.style.border = '';
                }, 2000);

            }
        }
    });

    if (!allAnswered) {
        showInfo(`다음 문항에 답변을 입력해 주세요: ${emptyposts.join(', ')}`);
        return;
    }

    const hasSubjective = Array.from(posts).some(q => q.querySelector('textarea'));

    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    // Add additional data
    const domainGradeNameInput = document.createElement('input');
    domainGradeNameInput.type = 'hidden';
    domainGradeNameInput.name = 'domain_grade_detail_id';
    domainGradeNameInput.value = "{{ posts.0.apply_info.exam_phase_place.exam_phase.exam.domain_grade_detail.id }}";
    form.appendChild(domainGradeNameInput);

    // Submit the form
    document.body.appendChild(form);

    // 폼 데이터 생성
    const formData = new FormData(form);

    // fetch API를 사용하여 비동기 제출
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            if (window.opener) {
                try {
                    window.opener.location.href = "{% url 'basiccontent:post-end' %}";
                } catch (error) {
                    console.warn("부모 창 이동 실패", error);
                }
            }
            window.close();  // 새 창 닫기
        } else {
            alert('제출에 실패했습니다. 다시 시도해주세요.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('제출 중 오류가 발생했습니다.');
    });
}

</script>